(function(f){var a,e,c,d;a=function(g){if(!g.complete){return false}if(typeof g.naturalWidth!="undefined"&&g.naturalWidth==0){return false}return true};create_canvas_for=function(g){if(f.browser.msie){var h=document.createElement("canvas");h.setAttribute("width",g.width);h.setAttribute("height",g.height);G_vmlCanvasManager.initElement(h);h.getContext("2d").clearRect(0,0,h.width,h.height);return h}else{var i=f('<canvas style="width:'+g.width+"px;height:"+g.height+'px;"></canvas>').get(0);i.getContext("2d").clearRect(0,0,i.width,i.height);return i}};e={position:"absolute",left:0,top:0,padding:0,border:0};c=function(i,h,l,g,k){var j=i.getContext("2d");j.beginPath();j.moveTo(h,l);j.lineTo(g,k);j.lineWidth=2;j.closePath();j.strokeStyle="rgb(100,149,237)";j.stroke()};d=function(h,g,j){var i=h.getContext("2d");i.beginPath();i.arc(g,j,4,0,2*Math.PI,true);i.closePath();i.fillStyle="rgb(100,149,237)";i.fill()};var b={init:function(g){g=f.extend({},f.fn.imagecanvasmap.defaults,g);return this.each(function(){var k=f(this),i=k.data("imagecanvasmap");if(!i){var l=new Array();var j=new Array();if(!a(this)){return window.setTimeout(function(){k.imagecanvasmap(g)},200)}canvas=create_canvas_for(this);f(canvas).css(e);f(canvas).offset({top:f(this).offset().top,left:f(this).offset().left});canvas.height=this.height;canvas.width=this.width;k.before(canvas);var h=f(canvas);if(f.browser.msie){h=f(this)}h.click(function(o){if(!g.draw){return}var m=o.pageX-this.offsetLeft;var p=o.pageY-this.offsetTop;if(l.length>2){if(Math.abs(l[0]-m)<15&&Math.abs(j[0]-p)<15){g.draw=false;c(canvas,l[0],j[0],l[l.length-1],j[j.length-1]);g.onComplete();return}for(var n=1;n<l.length;n++){if(Math.abs(l[n]-m)<15&&Math.abs(j[n]-p)<15){return}}}else{for(var n=1;n<l.length;n++){if(Math.abs(l[n]-m)<15&&Math.abs(j[n]-p)<15){return}}}l.push(m);j.push(p);d(canvas,m,p);if(l.length>1){c(canvas,l[l.length-2],j[j.length-2],l[l.length-1],j[j.length-1])}});usemap=k.get(0).getAttribute("usemap");if(usemap){map=f('map[name="'+usemap.substr(1)+'"]');if(k.is("img")&&usemap&&map.size()>0){areas=map.find("area");areas.each(function(){coords=this.getAttribute("coords").split(",");for(var m=0;m<coords.length;m++){coords[m]=parseFloat(coords[m])}shape=this.getAttribute("shape").toLowerCase().substr(0,4);if(shape==="poly"){context=canvas.getContext("2d");context.beginPath();context.moveTo(coords[0],coords[1]);for(m=2;m<coords.length;m+=2){context.lineTo(coords[m],coords[m+1])}context.lineWidth=2;context.closePath();context.strokeStyle="rgb(100,149,237)";context.stroke()}else{if(shape==="rect"){context=canvas.getContext("2d");context.beginPath();context.moveTo(coords[0],coords[1]);context.lineTo(coords[2],coords[1]);context.lineTo(coords[2],coords[3]);context.lineTo(coords[0],coords[3]);context.lineWidth=2;context.closePath();context.strokeStyle="rgb(100,149,237)";context.stroke()}}})}}k.data("imagecanvasmap",{target:k,options:g,clickX:l,clickY:j,canvas:canvas})}})},clear:function(){return this.each(function(){var g=f(this).data("imagecanvasmap");g.canvas.getContext("2d").clearRect(0,0,g.canvas.width,g.canvas.height)})}};f.fn.imagecanvasmap=function(g){if(b[g]){return b[g].apply(this,Array.prototype.slice.call(arguments,1))}else{if(typeof g==="object"||!g){return b.init.apply(this,arguments)}else{f.error("Method "+g+" does not exist on jQuery.imagecanvasmap")}}};f.fn.imagecanvasmap.defaults={onComplete:function(){},draw:false}})(jQuery);