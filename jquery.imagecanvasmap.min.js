(function(f){var a,e,c,d;a=function(g){if(!g.complete){return false}if(typeof g.naturalWidth!="undefined"&&g.naturalWidth==0){return false}return true};create_canvas_for=function(g){if(f.browser.msie){var h=document.createElement("canvas");h.setAttribute("width",g.width);h.setAttribute("height",g.height);G_vmlCanvasManager.initElement(h);h.getContext("2d").clearRect(0,0,h.width,h.height);return h}else{var i=f('<canvas style="width:'+g.width+"px;height:"+g.height+'px;"></canvas>').get(0);i.getContext("2d").clearRect(0,0,i.width,i.height);return i}};e={position:"absolute",left:0,top:0,padding:0,border:0};c=function(i,h,l,g,k){var j=i.getContext("2d");j.beginPath();j.moveTo(h,l);j.lineTo(g,k);j.lineWidth=2;j.closePath();j.strokeStyle="rgb(100,149,237)";j.stroke()};d=function(h,g,j){var i=h.getContext("2d");i.beginPath();i.arc(g,j,4,0,2*Math.PI,true);i.closePath();i.fillStyle="rgb(100,149,237)";i.fill()};var b={init:function(g){g=f.extend({},f.fn.imagecanvasmap.defaults,g);return this.each(function(){var j=f(this),h=j.data("imagecanvasmap");if(!h){var k=new Array();var i=new Array();if(!a(this)){return window.setTimeout(function(){j.imagecanvasmap(g)},200)}wrapper=f("<div></div>").css({display:"block",background:'url("'+this.src+'")',position:"relative",padding:0,width:this.width,height:this.height});wrapper.addClass(j.attr("class"));j.before(wrapper).css("opacity",0).css(e).remove();if(f.browser.msie){j.css("filter","Alpha(opacity=0)")}wrapper.append(j);canvas=create_canvas_for(this);f(canvas).css(e);canvas.height=this.height;canvas.width=this.width;j.before(canvas);wrapper.click(function(o){if(!g.draw){return}var l=o.pageX-this.offsetLeft;var p=o.pageY-this.offsetTop;if(k.length>2){if(Math.abs(k[0]-l)<15&&Math.abs(i[0]-p)<15){g.draw=false;c(canvas,k[0],i[0],k[k.length-1],i[i.length-1]);var n="";for(var m=0;m<k.length;m++){n+=k[m]+","+i[m]+","}n=n.substr(0,n.length-1);g.onComplete(n);return}for(var m=1;m<k.length;m++){if(Math.abs(k[m]-l)<15&&Math.abs(i[m]-p)<15){return}}}else{for(var m=1;m<k.length;m++){if(Math.abs(k[m]-l)<15&&Math.abs(i[m]-p)<15){return}}}k.push(l);i.push(p);d(canvas,l,p);if(k.length>1){c(canvas,k[k.length-2],i[i.length-2],k[k.length-1],i[i.length-1])}});usemap=j.get(0).getAttribute("usemap");if(usemap){map=f('map[name="'+usemap.substr(1)+'"]');if(j.is("img")&&usemap&&map.size()>0){areas=map.find("area");areas.each(function(){coords=this.getAttribute("coords").split(",");for(var l=0;l<coords.length;l++){coords[l]=parseFloat(coords[l])}shape=this.getAttribute("shape").toLowerCase().substr(0,4);if(shape==="poly"){context=canvas.getContext("2d");context.beginPath();context.moveTo(coords[0],coords[1]);for(l=2;l<coords.length;l+=2){context.lineTo(coords[l],coords[l+1])}context.lineWidth=2;context.closePath();context.strokeStyle="rgb(100,149,237)";context.stroke()}else{if(shape==="rect"){context=canvas.getContext("2d");context.beginPath();context.rect(coords[0],coords[1],coords[2]-coords[0],coords[3]-coords[1]);context.lineWidth=2;context.closePath();context.strokeStyle="rgb(100,149,237)";context.stroke()}}});if(g.mouseover){f(map).find("area").bind("mouseover",g.mouseover)}if(g.mouseout){f(map).find("area").bind("mouseout",g.mouseout)}}}j.data("imagecanvasmap",{options:g,clickX:k,clickY:i,canvas:canvas})}})},draw:function(){return this.each(function(){var g=f(this).data("imagecanvasmap");g.options.draw=true})},clear:function(){return this.each(function(){var g=f(this).data("imagecanvasmap");g.canvas.getContext("2d").clearRect(0,0,g.canvas.width,g.canvas.height)})}};f.fn.imagecanvasmap=function(g){if(b[g]){return b[g].apply(this,Array.prototype.slice.call(arguments,1))}else{if(typeof g==="object"||!g){return b.init.apply(this,arguments)}else{f.error("Method "+g+" does not exist on jQuery.imagecanvasmap")}}};f.fn.imagecanvasmap.defaults={onComplete:function(){},draw:false}})(jQuery);